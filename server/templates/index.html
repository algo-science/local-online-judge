<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local Online Judge</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']]
        }
      };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <!-- CodeMirror -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/clike/clike.min.js"></script>
    
    <!-- Prism for static highlighting in list -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-clike.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-c.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-cpp.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-java.min.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #34495e;
            --accent: #3498db;
            --light: #ecf0f1;
            --bg-body: #f5f6fa;
            --bg-container: white;
            --text-main: #333;
            --text-secondary: #34495e;
            --border: #ddd;
            --item-hover: #f5f5f5;
            --item-bg: #f9f9f9;
            --nav-text: white;
        }

        [data-theme="dark"] {
            --primary: #1a1a1a;
            --secondary: #ecf0f1;
            --accent: #3498db;
            --light: #2c3e50;
            --bg-body: #121212;
            --bg-container: #1e1e1e;
            --text-main: #e0e0e0;
            --text-secondary: #ecf0f1;
            --border: #444;
            --item-hover: #2c2c2c;
            --item-bg: #252525;
            --nav-text: #e0e0e0;
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: var(--bg-body); color: var(--text-main); transition: background 0.3s, color 0.3s; }
        nav { background: var(--primary); color: var(--nav-text); padding: 1rem; display: flex; justify-content: space-between; align-items: center; }
        nav a { color: var(--nav-text); text-decoration: none; margin-left: 20px; cursor: pointer; font-weight: bold; }
        nav a:hover { color: var(--accent); }
        .container { max-width: 1000px; margin: 2rem auto; padding: 20px; background: var(--bg-container); border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); min-height: 80vh; }
        h1, h2, h3 { color: var(--text-secondary); }
        
        /* Forms */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, textarea, select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 4px; box-sizing: border-box; background: var(--bg-container); color: var(--text-main); }
        button { background: var(--accent); color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 1rem; }
        button:hover { opacity: 0.9; }
        
        /* Lists */
        .problem-item { padding: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .problem-item:last-child { border-bottom: none; }
        .problem-item a { color: var(--accent); text-decoration: none; font-weight: bold; font-size: 1.1rem; }
        
        /* Problem Detail */
        .problem-header { border-bottom: 2px solid var(--border); padding-bottom: 10px; margin-bottom: 20px; }
        .description { background: var(--item-bg); padding: 15px; border-radius: 4px; }
        .description img { max-width: 100%; }
        .code-editor { font-family: monospace; min-height: 200px; border: 1px solid var(--border); }
        .CodeMirror { height: 400px; font-size: 14px; border-radius: 4px; }
        .submission-details { background: var(--item-bg); padding: 10px; margin-top: 5px; font-size: 0.9rem; display: none; }
        .submission-item:hover { background: var(--item-hover); }
        
        /* Status */
        .status-accepted { color: green; font-weight: bold; }
        .status-wrong { color: red; font-weight: bold; }
        .status-error { color: orange; font-weight: bold; }
        .status-solved { color: green; }
        
        .favorite-btn { color: #f1c40f; cursor: pointer; }
        
        .tabs { display: flex; border-bottom: 1px solid #ddd; }
        .tab-link { padding: 10px 15px; cursor: pointer; border-bottom: 2px solid transparent; }
        .tab-link.active { border-bottom-color: var(--accent); }
        .tab-content { display: none; padding-top: 15px; }
        .tab-content.active { display: block; }
        
        /* Helper classes */
        .hidden { display: none; }
        .btn-sm { padding: 5px 10px; font-size: 0.9rem; }
        .problem-group { border: 1px solid var(--border); border-radius: 4px; margin-bottom: 10px; }
        .group-header { background: var(--item-bg); padding: 10px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .problem-sublist { padding-left: 20px; border-top: 1px solid var(--border); display: block; } /* Initially visible */
        .btn-danger { background-color: #e74c3c; }
        .actions-menu { position: relative; }
        .actions-menu .dots { cursor: pointer; padding: 5px; }
        .actions-menu-content { display: none; position: absolute; right: 0; background-color: var(--bg-container); min-width: 160px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 1; border-radius: 4px; border: 1px solid var(--border); }
        .actions-menu-content a, .actions-menu-content .btn-sm { color: var(--text-main); padding: 12px 16px; text-decoration: none; display: block; background: none; width: 100%; text-align: left; border: none; }
        .actions-menu-content a:hover, .actions-menu-content .btn-sm:hover { background-color: var(--item-hover); }
        .show { display: block; }
        /* Tags */
        .tag-badge { background: var(--item-bg); color: var(--text-main); border: 1px solid var(--border); padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; margin-right: 5px; display: inline-block; }
        .tag-filter-container { margin-left: 10px; display: flex; align-items: center; gap: 5px; }
        .theme-toggle { cursor: pointer; font-size: 1.2rem; margin-left: 20px; }
        
        /* Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: var(--bg-container); margin: 15% auto; padding: 20px; border: 1px solid var(--border); border-radius: 8px; width: 80%; max-width: 500px; color: var(--text-main); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .modal-close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .modal-close:hover, .modal-close:focus { color: var(--text-main); text-decoration: none; cursor: pointer; }
        .modal-footer { margin-top: 20px; text-align: right; }
    </style>
</head>
<body>

<div id="custom-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modal-title" style="margin: 0;">Modal Title</h3>
            <span class="modal-close" onclick="closeModal()">&times;</span>
        </div>
        <div id="modal-body">
            <input type="text" id="modal-input" style="width: 100%;">
        </div>
        <div class="modal-footer">
            <button onclick="closeModal()" style="background: #95a5a6;">Cancel</button>
            <button id="modal-confirm-btn">Confirm</button>
        </div>
    </div>
</div>

<nav>
    <div class="logo">
        <a onclick="navigate('problems')" style="text-decoration: none; color: white; display: flex; align-items: center;">
            <img src="/static/AlgoScience.png" alt="AlgoScience Logo" style="height: 40px; margin-right: 10px;">
        </a>
    </div>
    <div>
        <a onclick="navigate('problems')">Problems</a>
        <a onclick="navigate('add-problem')">Add Problem</a>
        <a onclick="importProblems()">Import Problems</a>
        <a onclick="navigate('contests')">Contests</a>
        <a onclick="navigate('quizzes')">Quizzes</a>
        <i class="fas fa-moon theme-toggle" onclick="toggleTheme()" id="theme-icon" title="Toggle Dark Mode"></i>
    </div>
</nav>

<div class="container" id="app">
    <!-- Content injected here -->
</div>

<script>
    const app = document.getElementById('app');
    const modal = document.getElementById("custom-modal");
    const modalTitle = document.getElementById("modal-title");
    const modalInput = document.getElementById("modal-input");
    const modalConfirmBtn = document.getElementById("modal-confirm-btn");

    function openModal(title, placeholder, onConfirm, initialValue = "") {
        modalTitle.innerText = title;
        modalInput.placeholder = placeholder;
        modalInput.value = initialValue;
        modal.style.display = "block";
        modalInput.focus();
        
        // Remove previous event listeners
        const newBtn = modalConfirmBtn.cloneNode(true);
        modalConfirmBtn.parentNode.replaceChild(newBtn, modalConfirmBtn);
        
        // Reassign to the new button variable to keep reference fresh if we needed it globally,
        // but we just need to attach listener to the current element in DOM.
        const currentBtn = document.getElementById("modal-confirm-btn");
        
        currentBtn.onclick = () => {
            const value = modalInput.value;
            if (value) { // Or allow empty? Let's depend on the caller logic if needed
                onConfirm(value);
                closeModal();
            } else {
               // Optional: shake input or show error
               onConfirm(value); // Allow passing empty value, let callback handle validation
               closeModal();
            }
        };

        // Enter key to confirm
        modalInput.onkeyup = function(event) {
            if (event.key === 'Enter') {
                currentBtn.click();
            }
        }
    }

    function closeModal() {
        modal.style.display = "none";
    }

    window.onclick = function(event) {
        if (event.target == modal) {
            closeModal();
        }
        if (!event.target.matches('.dots') && !event.target.closest('.actions-menu-content')) {
            closeAllMenus();
        }
    }

    // Theme Logic
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    updateThemeIcon(savedTheme);

    function toggleTheme() {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        updateThemeIcon(newTheme);
    }

    function updateThemeIcon(theme) {
        const icon = document.getElementById('theme-icon');
        if (theme === 'dark') {
            icon.classList.remove('fa-moon');
            icon.classList.add('fa-sun');
        } else {
            icon.classList.remove('fa-sun');
            icon.classList.add('fa-moon');
        }
    }

    function navigate(view, params = {}) {
        window.location.hash = view;
        if (view === 'problems') renderProblemList();
        else if (view === 'problem') renderProblem(params.id);
        else if (view === 'add-problem') renderAddProblem();
        else if (view === 'contests') renderContestList();
        else if (view === 'contest') renderContest(params.id);
        else if (view === 'create-contest') renderCreateContest();
        else if (view === 'quizzes') renderQuizList();
    }

    async function renderProblemList(options = {}) {
        const { showFavorites = false, sortBy = 'default', filterBy = 'all', category = 'all', tag = 'all', showTags = true, search = '' } = options;
        console.log('Rendering problem list with options:', options);
        
        app.innerHTML = `
            <h2>Problems</h2>
            <div style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                <input type="text" id="search-input" placeholder="Search problems or sessions..." style="width: 200px;" oninput="renderProblemList(getFilterOptions())" value="${search}">
                <button onclick='renderProblemList({ "showFavorites": false })'>All</button>
                <button onclick='renderProblemList({ "showFavorites": true })'>Favorites</button>
                <select id="sort-by" onchange="renderProblemList(getFilterOptions())">
                    <option value="default">Sort by Default</option>
                    <option value="date_asc">Sort by Date (Oldest)</option>
                    <option value="date_desc">Sort by Date (Newest)</option>
                    <option value="rating_desc">Sort by Rating (High to Low)</option>
                    <option value="rating_asc">Sort by Rating (Low to High)</option>
                </select>
                <select id="filter-by" onchange="renderProblemList(getFilterOptions())">
                    <option value="all">Show All</option>
                    <option value="solved">Show Solved</option>
                    <option value="unsolved">Show Unsolved</option>
                </select>
                <div id="session-filter-container"></div>
                <div id="tag-filter-container"></div>
                <label style="display: flex; align-items: center; gap: 5px; font-weight: normal; margin-bottom: 0;">
                    <input type="checkbox" id="show-tags-toggle" ${showTags ? 'checked' : ''} onchange="renderProblemList(getFilterOptions())"> Show Tags
                </label>
                <button onclick="addSession()">Add Session</button>
            </div>
            <div id="problem-list">Loading...</div>
        `;
        
        // Restore focus to search input if it exists (it is re-created on render)
        const searchInput = document.getElementById('search-input');
        searchInput.focus();
        // Move cursor to end
        const val = searchInput.value;
        searchInput.value = '';
        searchInput.value = val;

        document.getElementById('sort-by').value = sortBy;
        document.getElementById('filter-by').value = filterBy;
        await renderSessionFilter(category);
        await renderTagFilter(tag);


        try {
            const res = await fetch('/api/problems');
            const groupedProblems = await res.json();
            
            // Helper to normalize the response structure since file_handler changed
            const normalizedGroups = {};
            for (const key in groupedProblems) {
                if (Array.isArray(groupedProblems[key])) {
                    normalizedGroups[key] = { problems: groupedProblems[key], docs: "" };
                } else {
                    normalizedGroups[key] = groupedProblems[key];
                }
            }

            let allProblems = [];
            for (const groupName in normalizedGroups) {
                const groupData = normalizedGroups[groupName];
                const problems = groupData.problems || [];
                problems.forEach(p => {
                    p.group = groupName;
                    allProblems.push(p);
                });
            }

            if (showFavorites) {
                allProblems = allProblems.filter(p => p.is_favorite);
            }
            if (filterBy === 'solved') {
                allProblems = allProblems.filter(p => p.status === 'Solved');
            } else if (filterBy === 'unsolved') {
                allProblems = allProblems.filter(p => p.status !== 'Solved');
            }
            
            const sessionRes = await fetch('/api/sessions');
            const sessions = await sessionRes.json();
            if (category !== 'all') {
                const sessionProblems = sessions.find(s => s.name === category)?.problems || [];
                allProblems = allProblems.filter(p => sessionProblems.includes(p.id));
            }
            if (tag !== 'all') {
                allProblems = allProblems.filter(p => p.tags && p.tags.includes(tag));
            }

            if (search) {
                const lowerSearch = search.toLowerCase();
                allProblems = allProblems.filter(p =>
                    p.title.toLowerCase().includes(lowerSearch) ||
                    p.group.toLowerCase().includes(lowerSearch)
                );
            }


            if (sortBy === 'date_asc') {
                allProblems.sort((a, b) => a.id.split('-')[0] - b.id.split('-')[0]); // simplified date sort
            } else if (sortBy === 'date_desc') {
                allProblems.sort((a, b) => b.id.split('-')[0] - a.id.split('-')[0]);
            } else if (sortBy === 'rating_desc') {
                allProblems.sort((a, b) => (b.rating || 0) - (a.rating || 0));
            } else if (sortBy === 'rating_asc') {
                allProblems.sort((a, b) => (a.rating || 0) - (b.rating || 0));
            }
            
            // Regroup after filtering/sorting
            const finalGrouped = {};
            allProblems.forEach(p => {
                if (!finalGrouped[p.group]) finalGrouped[p.group] = [];
                finalGrouped[p.group].push(p);
            });

            let hasProblems = false;
            let listHtml = '';
            const sessionList = await getSessionsForSelect();
            const sessionOptions = sessionList.map(s => `<option value="${s.name}">${s.name}</option>`).join('');

            for (const groupName in finalGrouped) {
                const problems = finalGrouped[groupName];
                if (problems.length === 0) continue;
                hasProblems = true;

                const groupDocs = normalizedGroups[groupName]?.docs || '';
                const docsHtml = groupDocs ? `<div class="description" style="margin-bottom: 10px; border-left: 4px solid var(--accent);">${marked.parse(groupDocs)}</div>` : '';

                const actionsHtml = groupName === 'Uncategorized' ? '' : `
                    <div class="actions-menu">
                        <i class="fas fa-ellipsis-h dots" onclick="toggleActionsMenu(event, '${groupName}')"></i>
                        <div id="actions-${groupName}" class="actions-menu-content">
                            <a href="#" onclick="renameSession('${groupName}')">Rename</a>
                            <a href="#" onclick="deleteGroup(event, '${groupName}')">Delete</a>
                        </div>
                    </div>
                `;

                listHtml += `
                    <div class="problem-group">
                        <div class="group-header" onclick="toggleGroup('${groupName}')">
                            <strong>${groupName}</strong>
                            ${actionsHtml}
                        </div>
                        <div id="group-${groupName}" class="problem-sublist">
                            ${docsHtml}
                `;
                problems.forEach(p => {
                    const tagsHtml = showTags && p.tags ?
                        `<div style="margin-top: 5px; margin-left: 25px;">${p.tags.map(t => `<span class="tag-badge">${t}</span>`).join('')}</div>` : '';
                    
                    const ratingHtml = p.rating ? `<span class="tag-badge" style="background: #ffc107; color: #333;">★ ${p.rating}</span>` : '';

                    listHtml += `
                        <div class="problem-item">
                            <div style="flex-grow: 1;">
                                <a href="#" onclick="navigate('problem', {id: '${p.id}'}); return false;">
                                    <i class="favorite-btn ${p.is_favorite ? 'fas' : 'far'} fa-star" onclick="toggleFavorite(event, '${p.id}')"></i>
                                    ${p.title}
                                    ${p.status === 'Solved' ? '<i class="fas fa-check-circle status-solved" style="margin-left: 8px;"></i>' : ''}
                                    ${ratingHtml}
                                </a>
                                ${tagsHtml}
                            </div>
                            <div class="actions-menu">
                                <i class="fas fa-ellipsis-v dots" onclick="toggleActionsMenu(event, '${p.id}')"></i>
                                <div id="actions-${p.id}" class="actions-menu-content">
                                    <a href="#" onclick="navigate('problem', {id: '${p.id}'})">Solve</a>
                                    <select onchange="assignToSession(event, '${p.id}')" class="session-assign">
                                        <option value="">Assign to...</option>
                                        ${sessionOptions}
                                    </select>
                                    <a href="#" onclick="manageTags(event, '${p.id}', '${(p.tags || []).join(',')}')">Manage Tags</a>
                                    <a href="#" onclick="setRating(event, '${p.id}', ${p.rating || 0})">Set Rating</a>
                                    <button class="btn-sm btn-danger" onclick="deleteProblem(event, '${p.id}')">Delete</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                listHtml += '</div></div>';
            }

            if (!hasProblems) {
                document.getElementById('problem-list').innerHTML = '<p>No problems found.</p>';
            } else {
                document.getElementById('problem-list').innerHTML = listHtml;
            }
        } catch (e) {
            console.error(e);
            document.getElementById('problem-list').innerHTML = '<p>Error loading problems.</p>';
        }
    }

    function getFilterOptions() {
        return {
            showFavorites: document.querySelector('button.active') ? document.querySelector('button.active').innerText === 'Favorites' : false,
            sortBy: document.getElementById('sort-by').value,
            filterBy: document.getElementById('filter-by').value,
            category: document.getElementById('session-filter') ? document.getElementById('session-filter').value : 'all',
            tag: document.getElementById('tag-filter') ? document.getElementById('tag-filter').value : 'all',
            showTags: document.getElementById('show-tags-toggle') ? document.getElementById('show-tags-toggle').checked : true,
            search: document.getElementById('search-input') ? document.getElementById('search-input').value : ''
        }
    }

    async function getSessionsForSelect() {
        try {
            const res = await fetch('/api/sessions');
            if (!res.ok) return [];
            return await res.json();
        } catch (e) {
            return [];
        }
    }

    async function renderSessionFilter(selectedSession = 'all') {
        const container = document.getElementById('session-filter-container');
        const sessions = await getSessionsForSelect();
        let options = '<option value="all">All Sessions</option>';
        sessions.forEach(s => {
            options += `<option value="${s.name}" ${s.name === selectedSession ? 'selected' : ''}>${s.name}</option>`;
        });
        container.innerHTML = `<select id="session-filter" onchange="renderProblemList(getFilterOptions())">${options}</select>`;
    }

    async function renderTagFilter(selectedTag = 'all') {
        const container = document.getElementById('tag-filter-container');
        try {
            const res = await fetch('/api/tags');
            const tags = await res.json();
            let options = '<option value="all">All Tags</option>';
            tags.forEach(t => {
                options += `<option value="${t}" ${t === selectedTag ? 'selected' : ''}>${t}</option>`;
            });
            container.innerHTML = `<select id="tag-filter" onchange="renderProblemList(getFilterOptions())">${options}</select>`;
        } catch (e) {
            console.error("Failed to load tags for filter", e);
        }
    }

    async function manageTags(event, problemId, currentTagsStr) {
        event.stopPropagation();
        closeAllMenus();
        openModal("Manage Tags", "Enter tags separated by commas", async (newTagsStr) => {
            if (newTagsStr !== null) {
                const tags = newTagsStr.split(',').map(t => t.trim()).filter(t => t);
                await fetch(`/api/problems/${problemId}/tags`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tags })
                });
                renderProblemList(getFilterOptions());
            }
        }, currentTagsStr);
    }

    async function setRating(event, problemId, currentRating) {
        event.stopPropagation();
        closeAllMenus();
        openModal("Set Rating", "Enter rating (0-3500)", async (newRating) => {
            if (newRating !== null) {
                const rating = parseInt(newRating, 10);
                if (isNaN(rating)) return;
                
                await fetch(`/api/problems/${problemId}/rating`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ rating })
                });
                renderProblemList(getFilterOptions());
            }
        }, currentRating ? String(currentRating) : "");
    }


    async function addSession() {
        openModal("Add Session", "Enter session name", async (name) => {
            if (name) {
                await fetch('/api/sessions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name }),
                });
                renderProblemList(getFilterOptions());
            }
        });
    }

    async function assignToSession(event, problemId) {
        const session = event.target.value;
        if (!session) return;
        await fetch('/api/sessions/assign', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ session_name: session, problem_id: problemId }),
        });
        alert(`Problem assigned to ${session}`);
        event.target.value = '';
        renderProblemList(getFilterOptions());
    }

    async function renameSession(oldName) {
        openModal("Rename Session", "Enter new session name", async (newName) => {
            if (newName && newName !== oldName) {
                await fetch('/api/sessions/rename', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ old_name: oldName, new_name: newName }),
                });
                renderProblemList(getFilterOptions());
            }
        }, oldName);
    }

    function toggleActionsMenu(event, problemId) {
        event.stopPropagation();
        closeAllMenus();
        document.getElementById(`actions-${problemId}`).classList.toggle("show");
    }

    function closeAllMenus() {
        var menus = document.getElementsByClassName("actions-menu-content");
        for (var i = 0; i < menus.length; i++) {
            var openMenu = menus[i];
            if (openMenu.classList.contains('show')) {
                openMenu.classList.remove('show');
            }
        }
    }

    // window.onclick handled with modal logic

    function toggleGroup(groupName) {
        const group = document.getElementById(`group-${groupName}`);
        group.style.display = group.style.display === 'none' ? 'block' : 'none';
    }

    async function deleteProblem(event, problemId) {
        event.stopPropagation();
        if (confirm('Are you sure you want to delete this problem?')) {
            await fetch(`/api/problems/${problemId}`, { method: 'DELETE' });
            renderProblemList();
        }
    }

    async function deleteGroup(event, groupName) {
        event.stopPropagation();
        if (confirm(`Are you sure you want to delete the entire '${groupName}' group?`)) {
            await fetch(`/api/problems/group/${groupName}`, { method: 'DELETE' });
            renderProblemList();
        }
    }

    async function importProblems() {
        if (confirm('Are you sure you want to import problems from the server/problems directory?')) {
            await fetch('/api/import', { method: 'POST' });
            renderProblemList();
        }
    }

    async function toggleFavorite(event, problemId, isProblemView = false) {
        event.stopPropagation();
        await fetch(`/api/problems/${problemId}/favorite`, { method: 'POST' });
        if (isProblemView) {
            renderProblem(problemId);
        } else {
            renderProblemList();
        }
    }

    function openTab(event, tabName) {
        const tabcontent = document.getElementsByClassName("tab-content");
        for (let i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }
        const tablinks = document.getElementsByClassName("tab-link");
        for (let i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }
        document.getElementById(tabName).style.display = "block";
        event.currentTarget.className += " active";
    }

    async function saveNotes(problemId) {
        const notes = document.getElementById('user-notes').value;
        await fetch(`/api/problems/${problemId}/notes`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ notes })
        });
        alert('Notes saved!');
    }

    let timerInterval;
    function startTimer() {
        let seconds = 0;
        timerInterval = setInterval(() => {
            seconds++;
            const h = Math.floor(seconds / 3600).toString().padStart(2, '0');
            const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            document.getElementById('timer').innerText = `${h}:${m}:${s}`;
        }, 1000);
    }

    async function renderProblem(id) {
        app.innerHTML = 'Loading...';
        try {
            const res = await fetch(`/api/problems/${id}`);
            const problem = await res.json();
            
            // Fetch previous submissions
            const subRes = await fetch(`/api/submissions/${id}`);
            const submissions = await subRes.json();

            let submissionsHtml = '<h3>Previous Submissions</h3><div id="submissions-list-container" style="max-height: 500px; overflow-y: auto; border: 1px solid #eee; border-radius: 4px;"></div>';

            app.innerHTML = `
                <div class="problem-header">
                    <h2>
                        <i class="favorite-btn ${problem.is_favorite ? 'fas' : 'far'} fa-star" onclick="toggleFavorite(event, ${problem.id}, true)"></i>
                        ${problem.title}
                    </h2>
                    <div id="timer" style="font-size: 1.5rem; font-weight: bold;">00:00:00</div>
                </div>
                
                <div class="tabs">
                    <div class="tab-link active" onclick="openTab(event, 'description')">Description</div>
                    <div class="tab-link" onclick="openTab(event, 'editorial')">Editorial</div>
                    <div class="tab-link" onclick="openTab(event, 'user-editorials')">User Editorials</div>
                    <div class="tab-link" onclick="openTab(event, 'notes')">My Notes</div>
                </div>

                <div id="description" class="tab-content active">
                    <div class="description" id="problem-desc-content"></div>
                    <div style="display: flex; gap: 20px; margin-top: 20px;">
                        <div style="flex: 1;">
                            <h3>Input Format</h3>
                            <pre>${problem.input_format || 'N/A'}</pre>
                            <h3>Sample Input</h3>
                            <pre style="background:#eee; padding:10px;">${problem.sample_input || ''}</pre>
                        </div>
                        <div style="flex: 1;">
                            <h3>Output Format</h3>
                            <pre>${problem.output_format || 'N/A'}</pre>
                            <h3>Sample Output</h3>
                            <pre style="background:#eee; padding:10px;">${problem.sample_output || ''}</pre>
                        </div>
                    </div>
                </div>

                <div id="editorial" class="tab-content">
                    <div id="editorial-text"></div>
                </div>

                <div id="user-editorials" class="tab-content">
                    <div id="user-editorials-list"></div>
                </div>

                <div id="notes" class="tab-content">
                    <textarea id="user-notes" style="width: 100%; height: 200px;">${problem.user_notes || ''}</textarea>
                    <button onclick="saveNotes(${id})">Save Notes</button>
                </div>

                <hr>
                
                <h3>Submit Solution</h3>
                <form onsubmit="submitCode(event, '${id}')">
                    <div class="form-group">
                        <label>Language</label>
                        <select id="language" onchange="changeLanguage()">
                            <option value="python">Python 3</option>
                            <option value="cpp">C++ (g++)</option>
                            <option value="java">Java</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Code</label>
                        <textarea id="code" class="code-editor"></textarea>
                    </div>
                    <button type="submit" id="submit-btn">Submit</button>
                </form>
                
                <div id="submission-result" style="margin-top: 20px;"></div>
                
                <div id="submissions-container">${submissionsHtml}</div>
            `;

            // Initialize CodeMirror
            // Initialize CodeMirror before setting the language
            initEditor();

            // Set language from localStorage after editor is initialized
            const savedLang = localStorage.getItem('preferredLanguage');
            if (savedLang) {
                const langSelect = document.getElementById('language');
                if (langSelect) {
                    langSelect.value = savedLang;
                    // We need to call changeLanguage to update the editor's mode and template
                    changeLanguage(true);
                }
            }
            
            // Render submissions
            const submissionsContainer = document.getElementById('submissions-list-container');
            if (submissions.length > 0) {
                submissionsContainer.innerHTML = submissions.map(s => renderSubmissionItem(s)).join('');
                // Re-run Prism highlighting for the new content
                requestAnimationFrame(() => {
                    Prism.highlightAll();
                });
            } else {
                document.getElementById('submissions-container').innerHTML = '';
            }

            // Render user editorials
            const editorialsContainer = document.getElementById('user-editorials-list');
            const editorials = submissions.filter(s => s.is_editorial);
            if (editorials.length > 0) {
                editorialsContainer.innerHTML = editorials.map(e => `
                    <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                        <div style="flex: 1;">
                            <h4>User Solution</h4>
                            <pre><code class="language-${e.language}">${escapeHtml(e.code)}</code></pre>
                        </div>
                        <div style="flex: 1;">
                            <h4>Explanation</h4>
                            <div class="description">${marked.parse(e.editorial_text || 'No explanation provided.')}</div>
                        </div>
                    </div>
                `).join('');
                requestAnimationFrame(() => {
                    Prism.highlightAll();
                });
            } else {
                editorialsContainer.innerHTML = '<p>No user editorials for this problem yet.</p>';
            }

            // Render Markdown
            document.getElementById('problem-desc-content').innerHTML = marked.parse(problem.description || '');
            document.getElementById('editorial-text').innerHTML = marked.parse(problem.editorial || 'No editorial available.');

            // Re-run Prism highlighting
            Prism.highlightAll();

            // Render MathJax
            if (window.MathJax) {
                MathJax.typesetPromise().then(() => {
                    // MathJax rendering complete
                }).catch((err) => console.log(err));
            }

        } catch (e) {
            console.error(e);
            app.innerHTML = '<p>Error loading problem details.</p>';
        }
    }

    let editor;

    function initEditor() {
        const textarea = document.getElementById('code');
        const lang = document.getElementById('language').value;
        let mode;
        if (lang === 'cpp') {
            mode = 'text/x-c++src';
        } else if (lang === 'java') {
            mode = 'text/x-java';
        } else {
            mode = 'python';
        }
        
        editor = CodeMirror.fromTextArea(textarea, {
            lineNumbers: true,
            mode: mode,
            theme: 'monokai'
        });
        
        // Set initial template
        changeLanguage(true);
    }

    function changeLanguage(isInitial = false) {
        if (!editor) return;
        const lang = document.getElementById('language').value;
        
        // Save preference unless this is the initial, localStorage-driven call
        if (!isInitial) {
            localStorage.setItem('preferredLanguage', lang);
        }
        
        let mode = 'python';
        let template = '';

        if (lang === 'cpp') {
            mode = 'text/x-c++src';
            template = `#include <bits/stdc++.h>
using namespace std;

int main() {
    // Your code here
    return 0;
}`;
        } else if (lang === 'java') {
            mode = 'text/x-java';
            template = `import java.util.*;

public class Main {
    public static void main(String[] args) {
        // Your code here
    }
}`;
        } else { // Python
            template = `# Your code here`;
        }

        editor.setOption('mode', mode);
        
        if (isInitial || editor.getValue().trim() === '') {
            editor.setValue(template);
        }
    }

    function toggleSubmissionDetails(id) {
        const el = document.getElementById(`sub-details-${id}`);
        if (el.style.display === 'block') {
            el.style.display = 'none';
        } else {
            el.style.display = 'block';
            requestAnimationFrame(() => {
                const codes = el.querySelectorAll('code');
                codes.forEach(block => Prism.highlightElement(block));
            });
        }
    }
    
    function escapeHtml(text) {
        if (!text) return '';
        var map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, function(m) { return map[m]; });
    }

    function getStatusClass(status) {
        if (status === 'Accepted' || status === 'Success') return 'status-accepted';
        if (status.includes('Wrong')) return 'status-wrong';
        return 'status-error';
    }

    async function submitCode(e, problemId) {
        e.preventDefault();
        const btn = document.getElementById('submit-btn');
        const resultDiv = document.getElementById('submission-result');
        
        btn.disabled = true;
        btn.innerText = 'Running...';
        resultDiv.innerHTML = '';

        const language = document.getElementById('language').value;
        const code = editor.getValue();

        try {
            const res = await fetch('/api/submit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ problem_id: problemId, language, code })
            });
            const result = await res.json();
            
            let statusHtml = `
                <div style="padding: 15px; background: #fff; border: 1px solid #ddd; border-radius: 4px;">
                    <h3 class="${getStatusClass(result.status)}" style="margin-top:0">${result.status}</h3>
                    ${result.passed_count !== undefined ? `<p>Passed: ${result.passed_count}/${result.total_count} Test Cases</p>` : ''}
                    ${result.output ? `<pre style="background: #f5f5f5; padding: 10px; overflow-x: auto;">${result.output}</pre>` : ''}
                </div>
            `;
            
            resultDiv.innerHTML = statusHtml;
            
            // Refresh problem view after short delay to show new submission in list
            addSubmissionToList(result);
        } catch (e) {
            resultDiv.innerHTML = '<p style="color:red">Submission failed due to network error.</p>';
        } finally {
            btn.disabled = false;
            btn.innerText = 'Submit';
        }
    }

    function renderSubmissionItem(s) {
        const passedInfo = s.passed_count !== undefined ? `(${s.passed_count}/${s.total_count} Passed)` : '';
        const langClass = s.language === 'python' ? 'language-python' : (s.language === 'cpp' ? 'language-cpp' : 'language-java');
        
        return `
        <div class="submission-item" style="padding: 10px; border-bottom: 1px solid #eee;">
            <div style="display: flex; justify-content: space-between; cursor: pointer;" onclick="toggleSubmissionDetails(${s.id})">
                <span>
                    <span class="${getStatusClass(s.status)}">${s.status}</span>
                    <span style="color: #666; margin-left: 10px;">${passedInfo}</span>
                </span>
                <span style="color: #999; font-size: 0.9em;">${s.language} • ${new Date(s.timestamp).toLocaleString()}</span>
                <button class="btn-sm" onclick="toggleEditorial(event, '${s.problem_id}', ${s.id})">
                    ${s.is_editorial ? 'Remove from Editorials' : 'Add to Editorials'}
                </button>
            </div>
            <div id="sub-details-${s.id}" class="submission-details" style="cursor: default;">
                <div style="margin-top: 10px;">
                    <strong>Code:</strong>
                    <pre><code class="${langClass}">${escapeHtml(s.code)}</code></pre>
                </div>
                ${s.details ? `
                <div style="margin-top: 10px;">
                    <strong>Test Cases:</strong>
                    <div style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px;">
                        ${s.details.map(d => `
                            <div style="width: 20px; height: 20px; border-radius: 50%; background: ${d.status === 'Passed' ? '#2ecc71' : '#e74c3c'};" title="Case ${d.id}: ${d.status}"></div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
                ${s.status !== 'Accepted' && s.output ? `<div style="margin-top:10px; color: #e74c3c; font-family: monospace; white-space: pre-wrap;">${s.output}</div>` : ''}
            </div>
        </div>
        `;
    }

    function addSubmissionToList(submission) {
        const container = document.getElementById('submissions-list-container');
        if (container) {
            const itemHtml = renderSubmissionItem(submission);
            container.insertAdjacentHTML('afterbegin', itemHtml);
            requestAnimationFrame(() => {
                Prism.highlightAll();
            });
        }
    }

    function renderAddProblem() {
        app.innerHTML = `
            <h2>Add New Problem</h2>
            <form onsubmit="addProblem(event)">
                <div class="form-group">
                    <label>Title</label>
                    <input type="text" id="p-title" required>
                </div>
                <div class="form-group">
                    <label>Description (Markdown & LaTeX supported)</label>
                    <textarea id="p-desc" rows="10" required placeholder="Write your problem statement here. You can use Markdown and LaTeX (e.g., $x^2$)."></textarea>
                </div>
                <div class="form-group">
                    <label>Input Format</label>
                    <textarea id="p-input" rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label>Output Format</label>
                    <textarea id="p-output" rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label>Sample Input</label>
                    <textarea id="p-sample-in" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Sample Output</label>
                    <textarea id="p-sample-out" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Test Cases</label>
                    <div id="test-cases-container"></div>
                    <button type="button" onclick="addTestCase()" class="btn-sm" style="margin-top:5px; background: #34495e;">+ Add Test Case</button>
                </div>
                <div class="form-group">
                    <label>Editorial (Markdown & LaTeX supported)</label>
                    <textarea id="p-editorial" rows="10" placeholder="Explanation of the solution..."></textarea>
                </div>
                <button type="submit">Create Problem</button>
            </form>
        `;
    }

    async function addProblem(e) {
        e.preventDefault();
        const data = {
            title: document.getElementById('p-title').value,
            description: document.getElementById('p-desc').value,
            input_format: document.getElementById('p-input').value,
            output_format: document.getElementById('p-output').value,
            sample_input: document.getElementById('p-sample-in').value,
            sample_output: document.getElementById('p-sample-out').value,
            test_cases: collectTestCases(),
            editorial: document.getElementById('p-editorial').value
        };

        try {
            const res = await fetch('/api/problems', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            if (res.ok) {
                alert('Problem added!');
                navigate('problems');
            } else {
                alert('Failed to add problem');
            }
        } catch (e) {
            alert('Error adding problem: ' + e.message);
        }
    }

    function addTestCase() {
        const container = document.getElementById('test-cases-container');
        const id = Date.now();
        const html = `
            <div class="test-case-item" id="tc-${id}" style="background: #f9f9f9; padding: 10px; border: 1px solid #ddd; margin-bottom: 10px; border-radius: 4px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <strong>Test Case</strong>
                    <button type="button" class="btn-sm" onclick="removeTestCase('${id}')" style="background: #e74c3c;">Remove</button>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <label style="font-size: 0.9em;">Input</label>
                        <textarea class="tc-input" rows="2" style="font-family: monospace;"></textarea>
                    </div>
                    <div>
                        <label style="font-size: 0.9em;">Output</label>
                        <textarea class="tc-output" rows="2" style="font-family: monospace;"></textarea>
                    </div>
                </div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', html);
    }

    function removeTestCase(id) {
        document.getElementById(`tc-${id}`).remove();
    }

    function collectTestCases() {
        const testCases = [];
        document.querySelectorAll('.test-case-item').forEach(item => {
            testCases.push({
                input: item.querySelector('.tc-input').value,
                output: item.querySelector('.tc-output').value
            });
        });
        return testCases;
    }

    async function renderContestList() {
        app.innerHTML = `
            <h2>Contests</h2>
            <button onclick="navigate('create-contest')">Create New Contest</button>
            <div id="contest-list">Loading...</div>
        `;
        const res = await fetch('/api/contests');
        const contests = await res.json();
        const listHtml = contests.map(c => `
            <div class="problem-item">
                <a href="#" onclick="navigate('contest', {id: ${c.id}}); return false;">${c.name}</a>
            </div>
        `).join('');
        document.getElementById('contest-list').innerHTML = listHtml;
    }

    async function toggleEditorial(event, problemId, submissionId) {
        event.stopPropagation();
        await fetch(`/api/submissions/${problemId}/${submissionId}/editorial`, { method: 'POST' });
        renderProblem(problemId);
    }

    async function renderContest(id) {
        const res = await fetch(`/api/contests/${id}`);
        const data = await res.json();
        const { contest, problems } = data;
        
        app.innerHTML = `
            <h2>${contest.name}</h2>
            <div id="contest-problem-list">
                ${problems.map(p => `
                    <div class="problem-item">
                        <a href="#" onclick="navigate('problem', {id: ${p.id}}); return false;">${p.title}</a>
                    </div>
                `).join('')}
            </div>
        `;
    }

    async function toggleEditorial(event, problemId, submissionId) {
        event.stopPropagation();
        await fetch(`/api/submissions/${problemId}/${submissionId}/editorial`, { method: 'POST' });
        renderProblem(problemId);
    }

    async function renderCreateContest() {
        const res = await fetch('/api/problems');
        const groupedProblems = await res.json();
        
        let problemOptions = '';
        for (const groupName in groupedProblems) {
            problemOptions += `<optgroup label="${groupName}">`;
            groupedProblems[groupName].forEach(p => {
                problemOptions += `<option value="${p.id}">${p.title}</option>`;
            });
            problemOptions += `</optgroup>`;
        }

        app.innerHTML = `
            <h2>Create Contest</h2>
            <form onsubmit="createContest(event)">
                <div class="form-group">
                    <label>Contest Name</label>
                    <input type="text" id="contest-name" required>
                </div>
                <div class="form-group">
                    <label>Select Problems</label>
                    <select id="contest-problems" multiple style="height: 200px;">
                        ${problemOptions}
                    </select>
                </div>
                <button type="submit">Create Contest</button>
            </form>
        `;
    }

    async function createContest(event) {
        event.preventDefault();
        const name = document.getElementById('contest-name').value;
        const selectedProblemIds = Array.from(document.getElementById('contest-problems').selectedOptions).map(opt => opt.value);

        await fetch('/api/contests', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, problem_ids: selectedProblemIds })
        });
        
        navigate('contests');
    }

    function renderQuizList() {
        app.innerHTML = `
            <h2>Quizzes</h2>
            <p>Quiz functionality is under construction.</p>
        `;
    }

    // Initial load
    navigate('problems');
</script>
</body>
</html>